generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER AUTHENTICATION & AUTHORIZATION
// ============================================

enum UserRole {
  TALENT
  EMPLOYER
  ADMIN
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  emailVerified DateTime?
  name          String?
  password      String?
  role          UserRole
  image         String?

  accounts        Account[]
  sessions        Session[]
  talentProfile   TalentProfile?
  employerProfile EmployerProfile?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
  @@index([role])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ============================================
// TALENT PROFILE
// ============================================

enum TalentTier {
  BASIC
  INTERVIEWED
  VERIFIED
}

model TalentProfile {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  firstName      String
  lastName       String
  phone          String?
  location       String
  profilePicture String?
  headline       String?
  summary        String? @db.Text

  currentRole       String?
  yearsOfExperience Int     @default(0)
  expectedSalaryMin Int?
  expectedSalaryMax Int?

  tier           TalentTier    @default(BASIC)
  subscriptionId String?
  subscription   Subscription? @relation(fields: [subscriptionId], references: [id])

  applicationsThisMonth Int      @default(0)
  lastApplicationReset  DateTime @default(now())

  cvBuildsUsed   Int @default(0)
  cvReviewsUsed  Int @default(0)
  cvBuildsLimit  Int @default(0)
  cvReviewsLimit Int @default(0)

  profileCompleteness Float    @default(0)
  profileViews        Int      @default(0)
  lastActive          DateTime @default(now())

  workExperiences WorkExperience[]
  educations      Education[]
  skills          TalentSkill[]
  certifications  Certification[]
  portfolioItems  PortfolioItem[]
  cvs             CV[]
  applications    Application[]
  interviews      Interview[]
  savedJobs       SavedJob[]
  savedSearches   SavedSearch[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tier, profileCompleteness])
  @@index([lastActive])
  @@index([userId])
}

model WorkExperience {
  id       String        @id @default(cuid())
  talentId String
  talent   TalentProfile @relation(fields: [talentId], references: [id], onDelete: Cascade)

  jobTitle    String
  company     String
  location    String?
  startDate   DateTime
  endDate     DateTime?
  isCurrent   Boolean   @default(false)
  description String?   @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([talentId])
}

model Education {
  id       String        @id @default(cuid())
  talentId String
  talent   TalentProfile @relation(fields: [talentId], references: [id], onDelete: Cascade)

  institution  String
  degree       String
  fieldOfStudy String
  startDate    DateTime
  endDate      DateTime?
  isCurrent    Boolean   @default(false)
  grade        String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([talentId])
}

model Skill {
  id       String  @id @default(cuid())
  name     String  @unique
  category String?

  talents TalentSkill[]

  createdAt DateTime @default(now())

  @@index([name])
}

model TalentSkill {
  id       String        @id @default(cuid())
  talentId String
  talent   TalentProfile @relation(fields: [talentId], references: [id], onDelete: Cascade)
  skillId  String
  skill    Skill         @relation(fields: [skillId], references: [id])

  proficiency       String?
  yearsOfExperience Int?

  @@unique([talentId, skillId])
  @@index([talentId])
  @@index([skillId])
}

model Certification {
  id       String        @id @default(cuid())
  talentId String
  talent   TalentProfile @relation(fields: [talentId], references: [id], onDelete: Cascade)

  name          String
  issuingOrg    String
  issueDate     DateTime
  expiryDate    DateTime?
  credentialId  String?
  credentialUrl String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([talentId])
}

model PortfolioItem {
  id       String        @id @default(cuid())
  talentId String
  talent   TalentProfile @relation(fields: [talentId], references: [id], onDelete: Cascade)

  title       String
  description String? @db.Text
  url         String?
  imageUrl    String?
  category    String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([talentId])
}

model CV {
  id       String        @id @default(cuid())
  talentId String
  talent   TalentProfile @relation(fields: [talentId], references: [id], onDelete: Cascade)

  fileName     String
  fileUrl      String
  fileSize     Int
  cloudinaryId String?
  isPrimary    Boolean @default(false)

  applications Application[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([talentId, isPrimary])
  @@index([talentId])
}

// ============================================
// EMPLOYER PROFILE
// ============================================

enum EmployerTier {
  BASIC
  PRO
  ENTERPRISE
}

model EmployerProfile {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  companyName String
  companyLogo String?
  industry    String
  companySize String
  website     String?
  description String? @db.Text
  location    String

  logo String?

  tier           EmployerTier  @default(BASIC)
  subscriptionId String?
  subscription   Subscription? @relation(fields: [subscriptionId], references: [id])

  activeJobsCount         Int      @default(0)
  activeJobsLimit         Int      @default(3)
  candidateViewsThisMonth Int      @default(0)
  candidateViewsLimit     Int      @default(50)
  lastViewsReset          DateTime @default(now())

  jobs       Job[]
  interviews Interview[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tier])
  @@index([userId])
}

// ============================================
// SUBSCRIPTIONS & PAYMENTS
// ============================================

enum SubscriptionStatus {
  ACTIVE
  EXPIRING_SOON
  EXPIRED
  CANCELLED
  PENDING_PAYMENT
}

model Subscription {
  id       String   @id @default(cuid())
  userId   String
  userType UserRole
  tier     String

  amount   Float
  currency String @default("NGN")

  startDate   DateTime
  endDate     DateTime
  status      SubscriptionStatus
  isRecurring Boolean            @default(true)

  paymentReference String    @unique
  paymentMethod    String?
  lastPaymentDate  DateTime?
  nextPaymentDate  DateTime?

  nombaTransactionId String?
  nombaPaymentLink   String?

  talents   TalentProfile[]
  employers EmployerProfile[]
  payments  Payment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, status])
  @@index([endDate])
  @@index([status])
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

model Payment {
  id             String       @id @default(cuid())
  subscriptionId String
  subscription   Subscription @relation(fields: [subscriptionId], references: [id])

  amount   Float
  currency String        @default("NGN")
  status   PaymentStatus

  nombaReference     String  @unique
  nombaTransactionId String?
  nombaPaymentLink   String?

  paymentMethod String?
  paidAt        DateTime?
  failureReason String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status, createdAt])
  @@index([nombaReference])
}

// ============================================
// JOBS
// ============================================

enum JobCategory {
  TECHNOLOGY
  HEALTHCARE
  FINANCE
  MARKETING
  SALES
  CUSTOMER_SERVICE
  ADMINISTRATION
  DOMESTIC_STAFF
  ENGINEERING
  EDUCATION
  HOSPITALITY
  LEGAL
  CREATIVE
  OTHER
}

enum EmploymentType {
  FULL_TIME
  PART_TIME
  CONTRACT
  INTERNSHIP
  REMOTE
  FREELANCE
}

enum JobStatus {
  DRAFT
  ACTIVE
  PAUSED
  CLOSED
  EXPIRED
}

model Job {
  id         String          @id @default(cuid())
  employerId String
  employer   EmployerProfile @relation(fields: [employerId], references: [id], onDelete: Cascade)

  title          String
  description    String         @db.Text
  category       JobCategory
  employmentType EmploymentType
  location       String
  isRemote       Boolean        @default(false)

  salaryMin      Int?
  salaryMax      Int?
  salaryCurrency String @default("NGN")

  requirements     String[]
  responsibilities String[]
  benefits         String[]

  status              JobStatus @default(DRAFT)
  isFeatured          Boolean   @default(false)
  featuredUntil       DateTime?
  applicationDeadline DateTime?

  postToLinkedIn Boolean @default(false)
  linkedInPosted Boolean @default(false)
  linkedInUrl    String?

  views            Int @default(0)
  applicationCount Int @default(0)

  screeningQuestions ScreeningQuestion[]

  applications   Application[]
  savedByTalents SavedJob[]

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  publishedAt DateTime?

  @@index([employerId, status])
  @@index([category, status])
  @@index([status, publishedAt])
  @@index([isFeatured, publishedAt])
}

model ScreeningQuestion {
  id    String @id @default(cuid())
  jobId String
  job   Job    @relation(fields: [jobId], references: [id], onDelete: Cascade)

  question     String
  questionType String
  options      String[]
  isRequired   Boolean  @default(true)
  order        Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([jobId])
}

// ============================================
// APPLICATIONS
// ============================================

enum ApplicationStage {
  APPLIED
  SCREENING
  SHORTLISTED
  INTERVIEW
  OFFER
  HIRED
  REJECTED
}

enum ApplicationStatus {
  ACTIVE
  WITHDRAWN
  EXPIRED
}

model Application {
  id       String        @id @default(cuid())
  jobId    String
  job      Job           @relation(fields: [jobId], references: [id], onDelete: Cascade)
  talentId String
  talent   TalentProfile @relation(fields: [talentId], references: [id], onDelete: Cascade)

  coverLetter String? @db.Text
  cvId        String?
  cv          CV?     @relation(fields: [cvId], references: [id])

  stage  ApplicationStage  @default(APPLIED)
  status ApplicationStatus @default(ACTIVE)

  rating          Int?
  notes           String? @db.Text
  rejectionReason String?

  screeningAnswers Json?

  appliedAt     DateTime  @default(now())
  reviewedAt    DateTime?
  interviewedAt DateTime?
  decidedAt     DateTime?

  interviews    Interview[]
  statusHistory ApplicationStatusHistory[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([jobId, talentId])
  @@index([talentId, stage])
  @@index([jobId, stage])
  @@index([stage, status])
}

model ApplicationStatusHistory {
  id            String      @id @default(cuid())
  applicationId String
  application   Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  fromStage ApplicationStage?
  toStage   ApplicationStage
  changedBy String
  notes     String?

  createdAt DateTime @default(now())

  @@index([applicationId, createdAt])
}

// ============================================
// INTERVIEWS
// ============================================

enum InterviewStatus {
  SCHEDULED
  RESCHEDULED
  COMPLETED
  CANCELLED
  NO_SHOW
}

model Interview {
  id            String          @id @default(cuid())
  applicationId String
  application   Application     @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  jobId         String
  talentId      String
  talent        TalentProfile   @relation(fields: [talentId], references: [id])
  employerId    String
  employer      EmployerProfile @relation(fields: [employerId], references: [id])

  scheduledAt DateTime
  duration    Int
  timezone    String

  meetingRoomUrl String?
  meetingRoomId  String?

  status InterviewStatus @default(SCHEDULED)

  notes String? @db.Text

  scorecard InterviewScorecard?

  remindersSent Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([talentId, status])
  @@index([employerId, scheduledAt])
  @@index([applicationId])
}

model InterviewScorecard {
  id          String    @id @default(cuid())
  interviewId String    @unique
  interview   Interview @relation(fields: [interviewId], references: [id], onDelete: Cascade)

  technicalSkills Int
  communication   Int
  cultureFit      Int
  problemSolving  Int

  strengths             String[]
  concerns              String[]
  overallRecommendation String
  notes                 String?  @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============================================
// NOTIFICATIONS & COMMUNICATION
// ============================================

model Notification {
  id     String @id @default(cuid())
  userId String

  type    String
  title   String
  message String  @db.Text
  link    String?

  isRead Boolean   @default(false)
  readAt DateTime?

  createdAt DateTime @default(now())

  @@index([userId, isRead, createdAt])
  @@index([userId, createdAt])
}

model EmailTemplate {
  id        String   @id @default(cuid())
  name      String
  type      String
  subject   String
  body      String   @db.Text
  variables String[]

  isDefault Boolean @default(false)
  createdBy String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([type, isDefault])
}

// ============================================
// SAVED ITEMS
// ============================================

model SavedJob {
  id       String        @id @default(cuid())
  talentId String
  talent   TalentProfile @relation(fields: [talentId], references: [id], onDelete: Cascade)
  jobId    String
  job      Job           @relation(fields: [jobId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([talentId, jobId])
  @@index([talentId, createdAt])
}

model SavedSearch {
  id       String        @id @default(cuid())
  talentId String
  talent   TalentProfile @relation(fields: [talentId], references: [id], onDelete: Cascade)

  name         String
  filters      Json
  alertEnabled Boolean   @default(false)
  lastNotified DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([talentId])
}

// ============================================
// ADMIN & PLATFORM
// ============================================

model PlatformAnalytics {
  id   String   @id @default(cuid())
  date DateTime @unique

  totalUsers  Int
  newUsers    Int
  activeUsers Int

  totalTalents       Int
  basicTalents       Int
  interviewedTalents Int
  verifiedTalents    Int

  totalEmployers Int
  basicEmployers Int
  proEmployers   Int

  jobsPosted   Int
  applications Int
  interviews   Int
  hires        Int
  revenue      Float

  createdAt DateTime @default(now())

  @@index([date])
}

model SupportTicket {
  id     String @id @default(cuid())
  userId String

  subject     String
  description String @db.Text
  category    String
  priority    String
  status      String

  assignedTo String?
  resolution String? @db.Text

  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  resolvedAt DateTime?

  @@index([userId, status])
  @@index([status, priority])
}
